<link rel="import" href="wbhb-storyList.html" />
<link rel="import" href="../polymer/polymer-elements/polymer-signals/polymer-signals.html" />
<polymer-element name="wbhb-carosel" attributes="centreItem" extends="wbhb-storyList">
    <template>
        <polymer-signals on-polymer-signal-newStoryLoaded="newStoryLoaded"></polymer-signals>
        <div id="clipBox" style="width: 100%; overflow: hidden; clip:rect(0px,100px,100px,0px);">
                <content>
                </content>
            <template id="stories" repeat="{{stories}}">
                <wbhb-story class="hidden" story="{{}}"></wbhb-story>
            </template>
        </div>
    </template>
    <script>
        Polymer('wbhb-carosel', {
            centreItem: 0,
            fetchAhead: 2,
            
            ready: function() {
                this.super();
                
                this.resetStyleInheritance = false;
                this.applyAuthorStyles = true;
                
                // fetch starting stories
                this.fetchStory(this.centreItem);
                
                for (var i = 1; i <= this.fetchAhead; i++) {
                    this.fetchStory(this.centreItem + i);
                }
                
                this.addEventListener('polymer-signal-newStoryLoaded', this.newStoryLoaded);
            },
            
            positionChildren: function() {
                var myStories = this.querySelectorAll("wbhb-story");
                
                for (var i = 0; i < myStories.length; i++) {
                    myStories[i].isOpen = false;
                    myStories[i].style.left = (i - this.centreItem) * 700 + 500 + "px";
                }   
            },
            
            centreItemChanged: function() {
                this.positionChildren();   
            },
            
            scroll: function(direction) {
                if (direction > 0) {
                    if (this.centreItem < this.stories.length - 1) {
                        this.centreItem++;
                        if (this.stories.length <= this.centreItem + this.fetchAhead) {
                            this.fetchMore();
                        }
                    } else {
                        //bounce
                    }
                }
                if (direction < 0) {
                    if (this.centreItem > 0) {
                        this.centreItem--;
                    } else {
                        //bounce
                    }
                }
            },
            
            fetchMore: function() {
                var next = this.centreItem + this.fetchAhead;
                this.fetchStory(next);
            },
            
            newStoryLoaded: function(e, detail, sender) {
                this.popStories();
                this.positionChildren();
            },
            
            popStories: function() {
         
                //pop stories from shadow DOM (a little clunky)
                var images = this.$.clipBox.querySelectorAll("wbhb-story");
                for (var i = 0; i < images.length; i++) {
                    var image = images[i];
                    image = image.parentNode.removeChild(image);
                    this.appendChild(image);
                    image.classList.add("visible");
                    image.classList.remove("hidden");
                }
            }
            
        });
  </script>
</polymer-element>